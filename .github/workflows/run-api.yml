name: Run API

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0,6,12,18 * * *"

jobs:
  run-api:
    runs-on: ubuntu-latest
    services:
      api:
        image: ${{vars.DOCKERHUB_USERNAME}}/${{vars.API_DOCKER_IMAGE_NAME}}
        env:
          API_KEY: ${{secrets.API_KEY}}
          GOOGLE_APPLICATION_CREDENTIALS: ${{secrets.FIREBASE_CREDENTIALS}}
          GOOGLE_CLOUD_PROJECT: ${{vars.GCLOUD_PROJECT}}
        ports:
          - 80:80
    steps:
      - name: Ping check
        run: |
          curl --location 'localhost/' \
          --header 'Authorization: Bearer ${{secrets.API_KEY}}'
      - name: Update contest cache for codeforces
        run: |
          curl --location 'localhost/api/contests/?website=codeforces&cache' \
          --header 'Authorization: Bearer ${{secrets.API_KEY}}'
      - name: Update contest cache for atcoder
        run: |
          curl --location 'localhost/api/contests/?website=atcoder&cache' \
          --header 'Authorization: Bearer ${{secrets.API_KEY}}'
